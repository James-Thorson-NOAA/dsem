---
title: "Dynamic factor analysis"
author: "James Thorson"
output: rmarkdown::html_vignette
#output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Dynamic factor analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# Install locally
#  devtools::install_local( R'(C:\Users\James.Thorson\Desktop\Git\dsem)', force=TRUE )
# Build
#  setwd(R'(C:\Users\James.Thorson\Desktop\Git\dsem)'); devtools::build_rmd("vignettes/vignette.Rmd"); rmarkdown::render( "vignettes/vignette.Rmd", rmarkdown::pdf_document())
```

```{r setup, echo=TRUE, message=FALSE}
library(dsem)
library(MARSS)
library(ggplot2)
data( harborSealWA, package="MARSS")
```

`dsem` is an R package for fitting dynamic structural equation models (DSEMs) with a simple user-interface and generic specification of simultaneous and lagged effects in a non-recursive structure. Here, we highlight how DSEM can be used to implement dynamic factor analysis (DFA).  We specifically replicate analysis using the Multivariate Autoregressive State-Space (MARSS) package.

## Dynamic factor analysis

We first illustrate a DFA model using three factors, using example code and data that is provided as an example in the MARSS package

```{r, echo=TRUE, message=FALSE, fig.width=7, fig.height=7}
# Load data
dat <- t(harborSealWA[,-1])

# DFA with 3 states; used BFGS because it fits much faster for this model
fit <- MARSS(dat, model = list(m=3), form="dfa", method="BFGS")
plot(fit)
```

In DSEM syntax, we can first fit a saturated (full-covariance) model using the argument `covs`:

```{r, echo=TRUE, message=FALSE, fig.width=7, fig.height=7}
#
tsdata = ts( cbind(harborSealWA[,-1]), start=1978)

#
mydsem = dsem( tsdata = tsdata,
               covs = c("SJF, SJI, EBays, PSnd, HC"),
               sem = "" )

```

Alternatively, we can specify three factors factors while estimating additional variance for each variable, and assuming that variables are measured without error:

```{r, echo=TRUE, message=FALSE, fig.width=7, fig.height=7}
#
tsdata = ts( cbind(harborSealWA[,-1], F1=NA, F2=NA, F3=NA), start=1978)

#
sem = "
  F1 <-> F1, 0, NA, 1
  F2 <-> F2, 0, NA, 1
  F3 <-> F3, 0, NA, 1
  F1 -> F1, 1, NA, 1
  F2 -> F2, 1, NA, 1
  F3 -> F3, 1, NA, 1
  F1 -> SJF, 0, f11      
  F1 -> SJI, 0, f12
  F1 -> EBays, 0, f13
  F1 -> PSnd, 0, f14
  F1 -> HC, 0, f15
  F2 -> SJI, 0, f22
  F2 -> EBays, 0, f23
  F2 -> PSnd, 0, f24
  F2 -> HC, 0, f25
  F3 -> EBays, 0, f33
  F3 -> PSnd, 0, f34
  F3 -> HC, 0, f35
  SJF <-> SJF, 0, var
  SJI <-> SJI, 0, var    
  EBays <-> EBays, 0, var     
  PSnd <-> PSnd, 0, var       
  HC <-> HC, 0, var
"

# DFA with 3 states; used BFGS because it fits much faster for this model
mydsem = dsem( tsdata = tsdata,
               sem = sem,
               family = c( rep("fixed",5), rep("fixed",3) ),
               control = dsem_control( getsd = TRUE,
                                       newton_loops = 1 ) )

# 
xhat_tj = as.list(mydsem$sdrep, what="Estimate")$x_tj
xse_tj = as.list(mydsem$sdrep, what="Std. Error")$x_tj
rownames(xhat_tj) = rownames(xse_tj) = time(tsdata)

# 
longform = expand.grid( Year=rownames(xhat_tj), Var=colnames(xhat_tj) )
longform$est = as.vector(xhat_tj)
longform$se = as.vector(xse_tj)
longform$upper = longform$est + 1.96*longform$se
longform$lower = longform$est - 1.96*longform$se

# 
ggplot(data=longform) +  #, aes(x=interaction(var,eq), y=Estimate, color=method)) +
  geom_point( aes(x=Year,y=est) ) +
  geom_errorbar( aes(ymax=as.numeric(upper),ymin=as.numeric(lower), x=Year), width=0.25 ) + 
  facet_grid( rows=vars(Var), scales="free" )
```

Finally, we can specify three factors factors while eliminating additional process error and estimating measurement errors:

```{r, echo=TRUE, message=FALSE, fig.width=7, fig.height=7}
#
tsdata = ts( cbind(harborSealWA[,-1], F1=NA, F2=NA, F3=NA), start=1978)

#
sem = "
  F1 <-> F1, 0, NA, 1
  F2 <-> F2, 0, NA, 1
  F3 <-> F3, 0, NA, 1
  F1 -> F1, 1, NA, 1
  F2 -> F2, 1, NA, 1
  F3 -> F3, 1, NA, 1
  F1 -> SJF, 0, f11      
  F1 -> SJI, 0, f12
  F1 -> EBays, 0, f13
  F1 -> PSnd, 0, f14
  F1 -> HC, 0, f15
  F2 -> SJI, 0, f22
  F2 -> EBays, 0, f23
  F2 -> PSnd, 0, f24
  F2 -> HC, 0, f25
  F3 -> EBays, 0, f33
  F3 -> PSnd, 0, f34
  F3 -> HC, 0, f35
  SJF <-> SJF, 0, NA, 0.01
  SJI <-> SJI, 0, NA, 0.01    
  EBays <-> EBays, 0, NA, 0.01     
  PSnd <-> PSnd, 0, NA, 0.01       
  HC <-> HC, 0, NA, 0.01
"

# DFA with 3 states; used BFGS because it fits much faster for this model
mydsem = dsem( tsdata = tsdata,
               sem = sem,
               family = c( rep("normal",5), rep("fixed",3) ),
               control = dsem_control( getsd = TRUE,
                                       newton_loops = 1,
                                       gmrf_parameterization = "projection" ) )

# 
xhat_tj = as.list(mydsem$sdrep, what="Estimate")$x_tj
xse_tj = as.list(mydsem$sdrep, what="Std. Error")$x_tj
rownames(xhat_tj) = rownames(xse_tj) = time(tsdata)

# 
longform = expand.grid( Year=rownames(xhat_tj), Var=colnames(xhat_tj) )
longform$est = as.vector(xhat_tj)
longform$se = as.vector(xse_tj)
longform$upper = longform$est + 1.96*longform$se
longform$lower = longform$est - 1.96*longform$se

# 
ggplot(data=longform) +  #, aes(x=interaction(var,eq), y=Estimate, color=method)) +
  geom_point( aes(x=Year,y=est) ) +
  geom_errorbar( aes(ymax=as.numeric(upper),ymin=as.numeric(lower), x=Year), width=0.25 ) + 
  facet_grid( rows=vars(Var), scales="free" )
```
