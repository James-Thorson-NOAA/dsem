<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dynamic factor analysis • dsem</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Dynamic factor analysis">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dsem</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/dynamic_factor_analysis.html">Dynamic factor analysis</a></li>
    <li><a class="dropdown-item" href="../articles/vignette.html">Demonstration of selected features</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/James-Thorson-NOAA/dsem/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Dynamic factor analysis</h1>
                        <h4 data-toc-skip class="author">James
Thorson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/James-Thorson-NOAA/dsem/blob/HEAD/vignettes/dynamic_factor_analysis.Rmd" class="external-link"><code>vignettes/dynamic_factor_analysis.Rmd</code></a></small>
      <div class="d-none name"><code>dynamic_factor_analysis.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="dynamic-factor-analysis">Dynamic factor analysis<a class="anchor" aria-label="anchor" href="#dynamic-factor-analysis"></a>
</h2>
<p><code>dsem</code> is an R package for fitting dynamic structural
equation models (DSEMs) with a simple user-interface and generic
specification of simultaneous and lagged effects in a potentially
recursive structure. Here, we highlight how DSEM can be used to
implement dynamic factor analysis (DFA). We specifically replicate
analysis using the Multivariate Autoregressive State-Space (MARSS)
package, using data that are provided as an example in the MARSS
package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://james-thorson-noaa.github.io/dsem/" class="external-link">dsem</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'dsem' was built under R version 4.4.2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://atsa-es.github.io/MARSS/" class="external-link">MARSS</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span> <span class="va">harborSealWA</span>, package<span class="op">=</span><span class="st">"MARSS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define helper function</span></span>
<span><span class="va">grab</span> <span class="op">=</span> \<span class="op">(</span><span class="va">x</span>,<span class="va">name</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">==</span><span class="va">name</span><span class="op">)</span><span class="op">]</span> </span>
<span></span>
<span><span class="co"># Define number of factors</span></span>
<span><span class="co"># n_factors &gt;= 3 doesn't seem to converge using DSEM or MARSS without penalties</span></span>
<span><span class="va">n_factors</span> <span class="op">=</span> <span class="fl">2</span> </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-marss">Using MARSS<a class="anchor" aria-label="anchor" href="#using-marss"></a>
</h2>
<p>We first illustrate a DFA model using two factors, fitted using
MARSS:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">harborSealWA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SJI"</span>,<span class="st">"EBays"</span>,<span class="st">"SJF"</span>,<span class="st">"PSnd"</span>,<span class="st">"HC"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DFA with 3 states; used BFGS because it fits much faster for this model</span></span>
<span><span class="va">fit_MARSS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://atsa-es.github.io/MARSS/reference/MARSS.html" class="external-link">MARSS</a></span><span class="op">(</span> <span class="va">dat</span>, </span>
<span>                    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>m<span class="op">=</span><span class="va">n_factors</span><span class="op">)</span>,</span>
<span>                    form<span class="op">=</span><span class="st">"dfa"</span>,</span>
<span>                    method<span class="op">=</span><span class="st">"BFGS"</span>,</span>
<span>                    silent <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span></code></pre></div>
<p>We can then plot the estimated factors (latent variables):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plots states using all data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_MARSS</span>, plot.type<span class="op">=</span><span class="st">"xtT"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynamic_factor_analysis_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; plot type = xtT Estimated states</span></span></code></pre>
<p>And the estimated predictor for measurements (manifest
variables):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot expectation for data using all data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_MARSS</span>, plot.type<span class="op">=</span><span class="st">"fitted.ytT"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynamic_factor_analysis_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; plot type =  fitted.ytT  Observations with fitted values</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="full-rank-covariance-using-dsem">Full-rank covariance using DSEM<a class="anchor" aria-label="anchor" href="#full-rank-covariance-using-dsem"></a>
</h2>
<p>In DSEM syntax, we can first fit a saturated (full-covariance) model
using the argument <code>covs</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add factors to data</span></span>
<span><span class="va">tsdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">harborSealWA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SJI"</span>,<span class="st">"EBays"</span>,<span class="st">"SJF"</span>,<span class="st">"PSnd"</span>,<span class="st">"HC"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, start<span class="op">=</span><span class="fl">1978</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Scale and center (matches with MARSS does when fitting a DFA)</span></span>
<span><span class="va">tsdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span> <span class="va">tsdata</span>, center<span class="op">=</span><span class="cn">TRUE</span>, scale<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Define SEM</span></span>
<span><span class="va">sem</span> <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  # Random-walk process for variables </span></span>
<span><span class="st">  SJF -&gt; SJF, 1, NA, 1</span></span>
<span><span class="st">  SJI -&gt; SJI, 1, NA, 1</span></span>
<span><span class="st">  EBays -&gt; EBays, 1, NA, 1</span></span>
<span><span class="st">  PSnd -&gt; PSnd, 1, NA, 1</span></span>
<span><span class="st">  HC -&gt; HC, 1, NA, 1</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="co"># Initial fit</span></span>
<span><span class="va">mydsem0</span> <span class="op">=</span> <span class="fu"><a href="../reference/dsem.html">dsem</a></span><span class="op">(</span> tsdata <span class="op">=</span> <span class="va">tsdata</span>,</span>
<span>               covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SJF, SJI, EBays, PSnd, HC"</span><span class="op">)</span>,</span>
<span>               sem <span class="op">=</span> <span class="va">sem</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"normal"</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>               control <span class="op">=</span> <span class="fu"><a href="../reference/dsem_control.html">dsem_control</a></span><span class="op">(</span> quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                       run_model <span class="op">=</span> <span class="cn">FALSE</span> <span class="op">)</span> <span class="op">)</span>   </span>
<span><span class="co">#&gt; 1 regions found.</span></span>
<span><span class="co">#&gt; Using 1 threads</span></span>
<span><span class="co">#&gt; 1 regions found.</span></span>
<span><span class="co">#&gt; Using 1 threads</span></span>
<span></span>
<span><span class="co"># fix all measurement errors at diagonal and equal</span></span>
<span><span class="va">map</span> <span class="op">=</span> <span class="va">mydsem0</span><span class="op">$</span><span class="va">tmb_inputs</span><span class="op">$</span><span class="va">map</span></span>
<span><span class="va">map</span><span class="op">$</span><span class="va">lnsigma_j</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">tsdata</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#</span></span>
<span><span class="va">mydsem_full</span> <span class="op">=</span> <span class="fu"><a href="../reference/dsem.html">dsem</a></span><span class="op">(</span> tsdata <span class="op">=</span> <span class="va">tsdata</span>,</span>
<span>               covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SJF, SJI, EBays, PSnd, HC"</span><span class="op">)</span>,</span>
<span>               sem <span class="op">=</span> <span class="va">sem</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"normal"</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>               control <span class="op">=</span> <span class="fu"><a href="../reference/dsem_control.html">dsem_control</a></span><span class="op">(</span> quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                       map <span class="op">=</span> <span class="va">map</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; 1 regions found.</span></span>
<span><span class="co">#&gt; Using 1 threads</span></span>
<span><span class="co">#&gt; 1 regions found.</span></span>
<span><span class="co">#&gt; Using 1 threads</span></span></code></pre></div>
<p>We can then define a custom function to plot states:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_states</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span> <span class="va">out</span>,</span>
<span>                        <span class="va">vars</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">tmb_inputs</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">y_tj</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># </span></span>
<span>  <span class="va">xhat_tj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">sdrep</span>,report<span class="op">=</span><span class="cn">TRUE</span>,what<span class="op">=</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">$</span><span class="va">z_tj</span><span class="op">[</span>,<span class="va">vars</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="va">xse_tj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">sdrep</span>,report<span class="op">=</span><span class="cn">TRUE</span>,what<span class="op">=</span><span class="st">"Std. Error"</span><span class="op">)</span><span class="op">$</span><span class="va">z_tj</span><span class="op">[</span>,<span class="va">vars</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># </span></span>
<span>  <span class="va">longform</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span> Year<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">tsdata</span><span class="op">)</span>, Var<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tsdata</span><span class="op">)</span><span class="op">[</span><span class="va">vars</span><span class="op">]</span> <span class="op">)</span></span>
<span>  <span class="va">longform</span><span class="op">$</span><span class="va">est</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">xhat_tj</span><span class="op">)</span></span>
<span>  <span class="va">longform</span><span class="op">$</span><span class="va">se</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">xse_tj</span><span class="op">)</span></span>
<span>  <span class="va">longform</span><span class="op">$</span><span class="va">upper</span> <span class="op">=</span> <span class="va">longform</span><span class="op">$</span><span class="va">est</span> <span class="op">+</span> <span class="fl">1.96</span><span class="op">*</span><span class="va">longform</span><span class="op">$</span><span class="va">se</span></span>
<span>  <span class="va">longform</span><span class="op">$</span><span class="va">lower</span> <span class="op">=</span> <span class="va">longform</span><span class="op">$</span><span class="va">est</span> <span class="op">-</span> <span class="fl">1.96</span><span class="op">*</span><span class="va">longform</span><span class="op">$</span><span class="va">se</span></span>
<span>  <span class="va">longform</span><span class="op">$</span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">tsdata</span><span class="op">[</span>,<span class="va">vars</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">longform</span><span class="op">)</span> <span class="op">+</span>  <span class="co">#, aes(x=interaction(var,eq), y=Estimate, color=method)) +</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,y<span class="op">=</span><span class="va">est</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,y<span class="op">=</span><span class="va">data</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"blue"</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">upper</span><span class="op">)</span>,ymin<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">lower</span><span class="op">)</span>, x<span class="op">=</span><span class="va">Year</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"grey"</span>, alpha<span class="op">=</span><span class="fl">0.2</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span> facets<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">Var</span><span class="op">)</span>, scales<span class="op">=</span><span class="st">"free"</span>, ncol<span class="op">=</span><span class="fl">2</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">plot_states</span><span class="op">(</span> <span class="va">mydsem_full</span> <span class="op">)</span></span></code></pre></div>
<p><img src="dynamic_factor_analysis_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>These estimated states follow the data more closely and have smaller
estimated confidence intervals. Presumably this occurs because we are
using a full-rank covariance so far.</p>
</div>
<div class="section level2">
<h2 id="reduced-rank-factor-model-with-measurement-errors">Reduced-rank factor model with measurement errors<a class="anchor" aria-label="anchor" href="#reduced-rank-factor-model-with-measurement-errors"></a>
</h2>
<p>Next, we can specify two factors factors while eliminating additional
process error and estimating measurement errors. This requires us to
switch to <code>gmrf_parameterization = "projection"</code>, so that we
can fit a rank-deficient Gaussian Markov random field:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add factors to data</span></span>
<span><span class="va">tsdata</span> <span class="op">=</span> <span class="va">harborSealWA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SJI"</span>,<span class="st">"EBays"</span>,<span class="st">"SJF"</span>,<span class="st">"PSnd"</span>,<span class="st">"HC"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">newcols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="cn">NA</span>,</span>
<span>                 dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tsdata</span><span class="op">)</span>,<span class="va">n_factors</span><span class="op">)</span>,</span>
<span>                 dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"F"</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_factors</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">tsdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">tsdata</span>, <span class="va">newcols</span><span class="op">)</span>, start<span class="op">=</span><span class="fl">1978</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Scale and center (matches with MARSS does when fitting a DFA)</span></span>
<span><span class="va">tsdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span> <span class="va">tsdata</span>, center<span class="op">=</span><span class="cn">TRUE</span>, scale<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#</span></span>
<span><span class="va">sem</span> <span class="op">=</span> <span class="fu"><a href="../reference/make_dfa.html">make_dfa</a></span><span class="op">(</span> variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SJI"</span>,<span class="st">"EBays"</span>,<span class="st">"SJF"</span>,<span class="st">"PSnd"</span>,<span class="st">"HC"</span><span class="op">)</span>,</span>
<span>                n_factors <span class="op">=</span> <span class="va">n_factors</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Initial fit</span></span>
<span><span class="va">mydsem0</span> <span class="op">=</span> <span class="fu"><a href="../reference/dsem.html">dsem</a></span><span class="op">(</span> tsdata <span class="op">=</span> <span class="va">tsdata</span>,</span>
<span>               sem <span class="op">=</span> <span class="va">sem</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"normal"</span>,<span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"fixed"</span>,<span class="va">n_factors</span><span class="op">)</span> <span class="op">)</span>,</span>
<span>               estimate_delta0 <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               control <span class="op">=</span> <span class="fu"><a href="../reference/dsem_control.html">dsem_control</a></span><span class="op">(</span> quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                       run_model <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                       gmrf_parameterization <span class="op">=</span> <span class="st">"projection"</span> <span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># fix all measurement errors at diagonal and equal</span></span>
<span><span class="va">map</span> <span class="op">=</span> <span class="va">mydsem0</span><span class="op">$</span><span class="va">tmb_inputs</span><span class="op">$</span><span class="va">map</span></span>
<span><span class="va">map</span><span class="op">$</span><span class="va">lnsigma_j</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">tsdata</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Fix factors to have initial value, and variables to not</span></span>
<span><span class="va">map</span><span class="op">$</span><span class="va">delta0_j</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">harborSealWA</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_factors</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Fix variables to have no stationary mean except what's predicted by initial value</span></span>
<span><span class="va">map</span><span class="op">$</span><span class="va">mu_j</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">tsdata</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># profile "delta0_j" to match MARSS (which treats initial condition as unpenalized random effect)</span></span>
<span><span class="va">mydfa</span> <span class="op">=</span> <span class="fu"><a href="../reference/dsem.html">dsem</a></span><span class="op">(</span> tsdata <span class="op">=</span> <span class="va">tsdata</span>,</span>
<span>               sem <span class="op">=</span> <span class="va">sem</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"normal"</span>,<span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"fixed"</span>,<span class="va">n_factors</span><span class="op">)</span> <span class="op">)</span>,</span>
<span>               estimate_delta0 <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               control <span class="op">=</span> <span class="fu"><a href="../reference/dsem_control.html">dsem_control</a></span><span class="op">(</span> quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                       map <span class="op">=</span> <span class="va">map</span>,</span>
<span>                                       use_REML <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                       <span class="co">#profile = "delta0_j",</span></span>
<span>                                       gmrf_parameterization <span class="op">=</span> <span class="st">"projection"</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>We again plot the estimated latent variables</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot estimated factors</span></span>
<span><span class="fu">plot_states</span><span class="op">(</span> <span class="va">mydfa</span>, vars<span class="op">=</span><span class="fl">5</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_factors</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p><img src="dynamic_factor_analysis_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>and the estimated predictor for manifest variables</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot estimated variables</span></span>
<span><span class="fu">plot_states</span><span class="op">(</span> <span class="va">mydfa</span>, vars<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span> <span class="op">)</span></span></code></pre></div>
<p><img src="dynamic_factor_analysis_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>This results in similar (but not identical) factor values using MARSS
and DSEM. In particular, DSEM has higher variance in early years. This
likely arises because the default MARSS implementation of DFA includes a
penalty of the initial state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐱</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\mathbf{x}_0</annotation></semantics></math>
with mean zero and variance of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mi>𝐈</mi></mrow><annotation encoding="application/x-tex">5\mathbf{I}</annotation></semantics></math>.
This term presumably provides additional information about the initial
year such that MARSS DFA results are not invariant to reversing the
order of the data.</p>
<p>To further explore, we can modify the MARSS DFA to eliminate the
prior on initial conditions, based on help from Dr. Eli Holmes. This
involves specifying:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract internal settings</span></span>
<span><span class="va">modmats</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_MARSS</span><span class="op">$</span><span class="va">model</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model Structure is</span></span>
<span><span class="co">#&gt; m: 2 state process(es)</span></span>
<span><span class="co">#&gt; n: 5 observation time series</span></span>
<span></span>
<span><span class="co"># Redefine defaults</span></span>
<span><span class="va">modmats</span><span class="op">$</span><span class="va">V0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_factors</span>, <span class="va">n_factors</span> <span class="op">)</span></span>
<span><span class="va">modmats</span><span class="op">$</span><span class="va">x0</span> <span class="op">&lt;-</span> <span class="st">"unequal"</span> </span>
<span></span>
<span><span class="co"># Refit</span></span>
<span><span class="va">fit_MARSS2</span> <span class="op">=</span> <span class="fu"><a href="https://atsa-es.github.io/MARSS/reference/MARSS.html" class="external-link">MARSS</a></span><span class="op">(</span> <span class="va">dat</span>, </span>
<span>                    model <span class="op">=</span> <span class="va">modmats</span>,</span>
<span>                    silent <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> abstol <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>                                    conv.test.slope.tol <span class="op">=</span> <span class="fl">0.01</span>, </span>
<span>                                    maxit <span class="op">=</span> <span class="fl">1000</span> <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>These have estimated time-series that are more similar to those from
DSEM</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plots states using all data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_MARSS2</span>, plot.type<span class="op">=</span><span class="st">"xtT"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynamic_factor_analysis_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; plot type = xtT Estimated states</span></span></code></pre>
<p>We can now compare the three options in terms of the fitted
log-likelihood:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare likelihood for MARSS and DSEM</span></span>
<span><span class="va">Table</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"MARSS"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit_MARSS</span><span class="op">)</span>, </span>
<span>           <span class="st">"DSEM"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">mydfa</span><span class="op">)</span>, </span>
<span>           <span class="st">"MARSS_no_pen"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit_MARSS2</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span> <span class="va">Table</span>, digits<span class="op">=</span><span class="fl">3</span><span class="op">)</span>       </span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">x</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">MARSS</td>
<td align="right">-45.924</td>
</tr>
<tr class="even">
<td align="left">DSEM</td>
<td align="right">-40.006</td>
</tr>
<tr class="odd">
<td align="left">MARSS_no_pen</td>
<td align="right">-40.026</td>
</tr>
</tbody>
</table>
<p>which confirms that the MARSS model without a penalty on initial
conditions results in the same likelihood as DSEM. Finally, we can also
compare the three options in terms of estimated loadings:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Table</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="st">"MARSS"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">fit_MARSS</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span>,</span>
<span>       <span class="st">"DSEM"</span> <span class="op">=</span> <span class="fu">grab</span><span class="op">(</span><span class="va">mydfa</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">par</span>,<span class="st">"beta_z"</span><span class="op">)</span>,</span>
<span>       <span class="st">"MARSS_no_pen"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">fit_MARSS2</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Table</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit_MARSS</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Table</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span> <span class="va">Table</span>, digits<span class="op">=</span><span class="fl">3</span><span class="op">)</span>       </span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">MARSS</th>
<th align="right">DSEM</th>
<th align="right">MARSS_no_pen</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Z.11</td>
<td align="right">-0.473</td>
<td align="right">0.362</td>
<td align="right">0.360</td>
</tr>
<tr class="even">
<td align="left">Z.21</td>
<td align="right">-0.440</td>
<td align="right">0.320</td>
<td align="right">0.332</td>
</tr>
<tr class="odd">
<td align="left">Z.31</td>
<td align="right">-0.465</td>
<td align="right">0.368</td>
<td align="right">0.356</td>
</tr>
<tr class="even">
<td align="left">Z.41</td>
<td align="right">-0.382</td>
<td align="right">0.299</td>
<td align="right">0.292</td>
</tr>
<tr class="odd">
<td align="left">Z.51</td>
<td align="right">0.075</td>
<td align="right">-0.128</td>
<td align="right">-0.065</td>
</tr>
<tr class="even">
<td align="left">Z.22</td>
<td align="right">0.213</td>
<td align="right">0.218</td>
<td align="right">0.213</td>
</tr>
<tr class="odd">
<td align="left">Z.32</td>
<td align="right">-0.134</td>
<td align="right">-0.150</td>
<td align="right">-0.157</td>
</tr>
<tr class="even">
<td align="left">Z.42</td>
<td align="right">-0.079</td>
<td align="right">-0.088</td>
<td align="right">-0.095</td>
</tr>
<tr class="odd">
<td align="left">Z.52</td>
<td align="right">0.924</td>
<td align="right">0.941</td>
<td align="right">0.944</td>
</tr>
</tbody>
</table>
<p>The estimating loadings are similar using DSEM and the MARSS model
without initial penalty, except with label switching (where some factors
and loadings can be multiplied by -1 with no change in the model):</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
